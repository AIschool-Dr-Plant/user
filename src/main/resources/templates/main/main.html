<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Main</title>
    <link rel="stylesheet" href="./css/mainStyle.css"> <!-- 메인 페이지 스타일링 -->

    <style>
	    #pagination {
		    display: block; /* visibility 확인 */
		}

	</style>



    <!--<script src="./js/mainScript.js" defer></script> <!-- 메인 페이지 스크립트 -->
    <script type="text/javascript">
	    // 병해충 데이터를 가져오는 함수
	    async function fetchPestData() {
	        const locNick = document.getElementById("locNickDropdown").value;
	        const locNickElement = document.getElementById("locNick");
	        if (locNick && locNickElement) {
	            locNickElement.innerText = locNick;
	            // 병해충 데이터 fetch 및 테이블 업데이트
	            const response = await fetch(`/getPestData?locNick=${locNick}`);
	            const data = await response.json();
	            populatePestTable(data);
	
	            // 방제 업체 데이터 fetch 및 페이지네이션 처리
	            await fetchCompanies(locNick);
	        }
	    }
 		
	 	// 상태 값에 따른 색상 클래스를 반환하는 함수
	    function getColorClass(value) {
	        switch (value) {
	            case 1: return "green";
	            case 2: return "yellow";
	            case 3: return "orange";
	            case 4: return "red";
	            case 5: return "gray";
	            default: return "gray"; // 기본 색상
	        }
	    }
	 	
	 	// 병해충 데이터를 테이블에 채우는 함수
	    function populatePestTable(data) {
	        const table = document.getElementById("tempestTable");
	        table.innerHTML = "";  // 기존 테이블 내용 초기화
	        data.forEach(row => {
	            table.innerHTML += `
	            <tr>
	    	    	<td rowspan="6">병 피해</td>
	    	        <td>검은무늬병</td>
	    	        <td><span class="circle ${getColorClass(row.검은무늬병)}"></span></td>
	    	        <td>뒷면흰가루병</td>
	    	        <td><span class="circle ${getColorClass(row.뒷면흰가루병)}"></span></td>
	    	        <td>줄기마름병</td>
	    	        <td><span class="circle ${getColorClass(row.줄기마름병)}"></span></td>
	    	    </tr>
	    	    <tr>
	    	        <td>검은별무늬병</td>
	    	        <td><span class="circle ${getColorClass(row.검은별무늬병)}"></span></td>
	    	        <td>배갈색썩음병</td>
	    	        <td><span class="circle ${getColorClass(row.배갈색썩음병)}"></span></td>
	    	        <td>탄저병</td>
	    	        <td><span class="circle ${getColorClass(row.탄저병)}"></span></td>
	    	    </tr>
	    	    <tr>
	    	        <td>겹무늬병</td>
	    	        <td><span class="circle ${getColorClass(row.겹무늬병)}"></span></td>
	    	        <td>붉은가지마름병</td>
	    	        <td><span class="circle ${getColorClass(row.붉은가지마름병)}"></span></td>
	    	        <td>푸른곰팡이병</td>
	    	        <td><span class="circle ${getColorClass(row.푸른곰팡이병)}"></span></td>
	    	    </tr>
	    	    <tr>
	    	        <td>과수화상병</td>
	    	        <td><span class="circle ${getColorClass(row.과수화상병)}"></span></td>
	    	        <td>붉은별무늬병</td>
	    	        <td><span class="circle ${getColorClass(row.붉은별무늬병)}"></span></td>
	    	        <td>흰가루병</td>
	    	        <td><span class="circle ${getColorClass(row.흰가루병)}"></span></td>
	    	    </tr>
	    	    <tr>
	    	        <td>그을음병</td>
	    	        <td><span class="circle ${getColorClass(row.그을음병)}"></span></td>
	    	        <td>잎검은점병</td>
	    	        <td><span class="circle ${getColorClass(row.잎검은점병)}"></span></td>
	    	        <td>흰날개무늬병</td>
	    	        <td><span class="circle ${getColorClass(row.흰날개무늬병)}"></span></td>
	    	    </tr>
	    	    <tr>
	    	        <td>근두암종병</td>
	    	        <td><span class="circle ${getColorClass(row.근두암종병)}"></span></td>
	    	        <td>잿빛곰팡이병</td>
	    	        <td><span class="circle ${getColorClass(row.잿빛곰팡이병)}"></span></td>
	    	        <td>흰별무늬병</td>
	    	        <td><span class="circle ${getColorClass(row.흰별무늬병)}"></span></td>
	    	    </tr>
	    	    <tr>
	    	    	<td rowspan="9">해충 피해</td>
	    	        <td>가루깍지벌레</td>
	    	        <td><span class="circle ${getColorClass(row.가루깍지벌레)}"></span></td>
	    	        <td>박쥐나방</td>
	    	        <td><span class="circle ${getColorClass(row.박쥐나방)}"></span></td>
	    	        <td>복숭아심식나방</td>
	    	        <td><span class="circle ${getColorClass(row.복숭아심식나방)}"></span></td>
	    	    </tr>
	    	    <tr>
	    	        <td>갈색매미충</td>
	    	        <td><span class="circle ${getColorClass(row.갈색매미충)}"></span></td>
	    	        <td>배나무둥글밑진딧물</td>
	    	        <td><span class="circle ${getColorClass(row.배나무둥글밑진딧물)}"></span></td>
	    	        <td>사과알락나방</td>
	    	        <td><span class="circle ${getColorClass(row.사과알락나방)}"></span></td>
	    	    </tr>
	    	    <tr>
	    	        <td>꼬마배나무이</td>
	    	        <td><span class="circle ${getColorClass(row.꼬마배나무이)}"></span></td>
	    	        <td>배나무면충</td>
	    	        <td><span class="circle ${getColorClass(row.배나무면충)}"></span></td>
	    	        <td>에모무늬잎말이나방</td>
	    	        <td><span class="circle ${getColorClass(row.에모무늬잎말이나방)}"></span></td>
	    	    </tr>
	    	    <tr>
	    	        <td>노랑쐐기나방</td>
	    	        <td><span class="circle ${getColorClass(row.노랑쐐기나방)}"></span></td>
	    	        <td>배나무방패벌레</td>
	    	        <td><span class="circle ${getColorClass(row.배나무방패벌레)}"></span></td>
	    	        <td>조팝나무진딧물</td>
	    	        <td><span class="circle ${getColorClass(row.조팝나무진딧물)}"></span></td>
	    	    </tr>
	    	    <tr>
	    	        <td>담배거세미나방</td>
	    	        <td><span class="circle ${getColorClass(row.담배거세미나방)}"></span></td>
	    	        <td>배나무벌</td>
	    	        <td><span class="circle ${getColorClass(row.배나무벌)}"></span></td>
	    	        <td>차응애</td>
	    	        <td><span class="circle ${getColorClass(row.차응애)}"></span></td>
	    	    </tr>
	    	    <tr>
	    	        <td>말매미</td>
	    	        <td><span class="circle ${getColorClass(row.말매미)}"></span></td>
	    	        <td>배나무벌</td>
	    	        <td><span class="circle ${getColorClass(row.배나무벌)}"></span></td>
	    	        <td>콩가루벌레</td>
	    	        <td><span class="circle ${getColorClass(row.콩가루벌레)}"></span></td>
	    	    </tr>
	    	    <tr>
	    	        <td>명주달팽이</td>
	    	        <td><span class="circle ${getColorClass(row.명주달팽이)}"></span></td>
	    	        <td>배나무이</td>
	    	        <td><span class="circle ${getColorClass(row.배나무이)}"></span></td>
	    	        <td>긴털이리응애</td>
	    	        <td><span class="circle ${getColorClass(row.긴털이리응애)}"></span></td>
	    	    </tr>
	    	    <tr>
	    	        <td>목화진딧물</td>
	    	        <td><span class="circle ${getColorClass(row.목화진딧물)}"></span></td>
	    	        <td>배명나방</td>
	    	        <td><span class="circle ${getColorClass(row.배명나방)}"></span></td>
	    	        <td></td>
	    	        <td></td>
	    	    </tr>
	    	    <tr>
	    	        <td>미국선녀벌레</td>
	    	        <td><span class="circle ${getColorClass(row.미국선녀벌레)}"></span></td>
	    	        <td>배혹벌</td>
	    	        <td><span class="circle ${getColorClass(row.배혹벌)}"></span></td>
	    	        <td></td>
	    	        <td></td>
	    	    </tr>
	            `;
	        });
	    }
	 	
	    // 방제 업체 데이터를 가져오는 함수 (페이지네이션 포함)
	    async function fetchCompanies(locNick, page = 0, size = 10) {
	        const companyResponse = await fetch(`/getCompanies?locNick=${locNick}&page=${page}&size=${size}`);
	        const companyData = await companyResponse.json();
	        populateCompanyTable(companyData);

	        const countResponse = await fetch(`/getCompanyCount?locNick=${locNick}`);
	        const totalCount = await countResponse.json();

	        if (totalCount > 0) {
	            createPagination(totalCount, page, size);
	        } else {
	            console.warn("No data available for pagination.");
	        }
	    }
	 	
	 	// 방제 업체 테이블을 채우는 함수
	    function populateCompanyTable(data) {
	        const table = document.getElementById("companyTable");
	        table.innerHTML = `
	            <tr>
	                <th>업체명</th>
	                <th>연락처</th>
	                <th>업무명</th>
	                <th>주소</th>
	            </tr>
	        `;
	        data.forEach(row => {
	            table.innerHTML += `
	                <tr>
	                    <td>${row.CMP_NM}</td>
	                    <td>${row.CONT}</td>
	                    <td>${row.BIZ_DIV}</td>
	                    <td><a href="">상세보기</a></td>
	                </tr>
	            `;
	        });
	    }
		
	    // 페이지네이션 버튼을 생성하는 함수
	    function createPagination(totalCount, currentPage, size) {
	        const paginationDiv = document.getElementById("pagination");
	        paginationDiv.innerHTML = '';
	        const totalPages = Math.ceil(totalCount / size);

	        for (let i = 0; i < totalPages; i++) {
	            const pageButton = document.createElement('button');
	            pageButton.textContent = i + 1;
	            pageButton.onclick = () => fetchCompanies(document.getElementById("locNickDropdown").value, i, size);
	            if (i === currentPage) {
	                pageButton.style.fontWeight = 'bold';
	            }
	            paginationDiv.appendChild(pageButton);
	        }
	    }
	    
	 	// 페이지네이션 로딩 함수
	    function loadPagination(totalPages, currentPage) {
	        const paginationContainer = document.getElementById('pagination');
	        paginationContainer.innerHTML = ''; // 기존 버튼 초기화

	        for (let i = 0; i < totalPages; i++) {
	            const button = document.createElement('button');
	            button.textContent = i + 1;
	            button.classList.add('page-button');
	            button.onclick = () => {
	                loadCompanies(i); // 특정 페이지의 회사 데이터 로드
	            };
	            if (i === currentPage) {
	                button.classList.add('active'); // 현재 페이지 강조
	            }
	            paginationContainer.appendChild(button);
	        }
	    }

	  
	    window.onload = function() {
	        fetchPestData();
	        fetchCompanies(); // 이 함수가 페이지 로드 시 호출되고 있는지 확인합니다.
	    };
    </script>
</head>
<body>
    <!-- 헤더를 외부 프래그먼트로부터 가져오기 -->
    <div th:replace="fragments/header :: siteHeader"></div>
    
    <main style="display: center;">
    	<section style="float:left; padding-right:30px;">
    		<!-- 관심 위치 병해충 예찰 섹션 -->
	        <article>
	        	
	        	<div>
		        	<h3>관심위치 병해충 예찰</h3>
		            <a th:href="@{/mypage(cusId=${cusId})}" style="float: right;">+관심위치</a> <!-- 관심 위치 추가 링크 -->
		            
	        	</div>
	            
	            <!-- 관심 위치 목록이 있을 경우 드롭다운 표시 -->
	            <div th:if="${locNickList != null}">
	                <label for="locNickDropdown">관심위치</label>
	                <select id="locNickDropdown" name="locNickDropdown" onchange="fetchPestData()"> <!-- 드롭다운 선택 시 데이터 불러오기 -->
	                    <option th:each="locNick : ${locNickList}" th:text="${locNick}" th:value="${locNick}" th:selected="${locNick == locNickList[0]}"></option>
	                </select>
	            </div>
	            
	            
	            <!-- 병해충 데이터를 표시할 테이블 -->
	            <table id="tempestTable" border="1"  style="width:100%;"></table>
	            <!-- 레이블 이미지 -->
	            <img src="./assets/img/label.png" 
	            	style="width:200px; height:20px; float:right;"> 
	            
	            <br>
	            <span id="locNick"></span> <!-- 선택된 위치 표시 -->
	            
            </article>
            
            <article>   
	            <span>인근 방제업체 리스트</span>
	            <!-- 방제 업체 데이터를 표시할 테이블 -->
	            <table id="companyTable" border="1"></table>
	            <div id="pagination"></div> <!-- 페이지네이션 버튼을 표시할 영역 -->
	        </article>
    	</section>
    	
        <section style="float:left;">
	        <!-- 농업 뉴스 섹션 -->
	        <article>
	        	<div>
	            	<h3>농업뉴스</h3>
	            
	            	<a th:href="@{/news(cusId=${cusId})}" style="float: right;">더보기</a> <!-- 뉴스 더보기 링크 -->
	            </div>
	            <br>
	            <table border="1">
	                <tr th:each="news : ${latestNews}">
	                    <td>
	                        <!-- 뉴스 제목 및 링크 -->
	                        <a th:href="${news.URL}" th:text="${news.TITLE}" target="_blank"></a> 
	                        <br>
	                        <!-- 뉴스 발행사, 기자 및 발행일 -->
	                        <span th:text="${news.PUB}"></span>
	                        <span th:text="${news.REPORTER}"></span>
	                        <span th:text="${news.PUB_DT}"></span>
	                    </td>
	                </tr>
	            </table>
	        </article>
	        
	        <!-- 날씨 예측 섹션 -->
	        <article>
	            <h3>날씨예측</h3>
	            <table border="1">
	                <tr>
	                    <th>항목</th>
	                    <th>오늘</th>
	                    <th>내일</th>
	                    <th>모레</th>
	                </tr>
	                <!-- 각 날씨 항목의 오늘, 내일, 모레 데이터 표시 -->
	                <tr>
	                    <td>AP</td>
	                    <td th:text="${latestWeatherData[2].AP}"></td>
	                    <td th:text="${latestWeatherData[1].AP}"></td>
	                    <td th:text="${latestWeatherData[0].AP}"></td>
	                </tr>
	                <tr>
	                    <td>HUM</td>
	                    <td th:text="${latestWeatherData[2].HUM}"></td>
	                    <td th:text="${latestWeatherData[1].HUM}"></td>
	                    <td th:text="${latestWeatherData[0].HUM}"></td>
	                </tr>
	                <tr>
	                    <td>TEMP</td>
	                    <td th:text="${latestWeatherData[2].TEMP}"></td>
	                    <td th:text="${latestWeatherData[1].TEMP}"></td>
	                    <td th:text="${latestWeatherData[0].TEMP}"></td>
	                </tr>
	                <tr>
	                    <td>WS</td>
	                    <td th:text="${latestWeatherData[2].WS}"></td>
	                    <td th:text="${latestWeatherData[1].WS}"></td>
	                    <td th:text="${latestWeatherData[0].WS}"></td>
	                </tr>
	                <tr>
	                    <td>WD</td>
	                    <td th:text="${latestWeatherData[2].WD}"></td>
	                    <td th:text="${latestWeatherData[1].WD}"></td>
	                    <td th:text="${latestWeatherData[0].WD}"></td>
	                </tr>
	                <tr>
	                    <td>RF</td>
	                    <td th:text="${latestWeatherData[2].RF}"></td>
	                    <td th:text="${latestWeatherData[1].RF}"></td>
	                    <td th:text="${latestWeatherData[0].RF}"></td>
	                </tr>
	                <tr>
	                    <td>MEAS_DT</td>
	                    <td th:text="${latestWeatherData[2].MEAS_DT}"></td>
	                    <td th:text="${latestWeatherData[1].MEAS_DT}"></td>
	                    <td th:text="${latestWeatherData[0].MEAS_DT}"></td>
	                </tr>
	            </table>
	        </article>
        </section>
    </main>
</body>
</html>
