<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Device Detail</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        canvas {
            display: block;
            margin: auto;
            max-width: 100%;
            width: 1000px; /* 조정 가능 */
            height: 600px; /* 조정 가능 */
        }
    </style>
    <script>
    let chartInstance = null; // Chart instance stored globally
    
    window.onload = function() {
        const locNick = document.getElementById('locNickSelect').value;
        fetchDeviceData(locNick, 1); // Load the temperature and humidity chart on page load
    };

    function fetchDeviceData(locNick, buttonType) {
        fetch(`/getDeviceData?locNick=${locNick}`)
            .then(response => response.json())
            .then(data => {
                drawGraph(data, buttonType);
            });
    }

    function drawGraph(data, buttonType) {
        const labels = data.map(item => item.meas_dt);
        let yValues = [];

        switch (buttonType) {
            case 1:
                yValues = [
                    { label: 'HUM', data: data.map(item => item.hum) },
                    { label: 'TEMP', data: data.map(item => item.temp) }
                ];
                break;
            case 2:
                yValues = [{ label: 'AP', data: data.map(item => item.ap) }];
                break;
            case 3:
                yValues = [{ label: 'WS', data: data.map(item => item.ws) }];
                break;
            case 4:
                yValues = [{ label: 'RF', data: data.map(item => item.rf) }];
                break;
        }

        const ctx = document.getElementById('chart').getContext('2d');

        // 기존 차트가 있다면 삭제하고 참조를 null로 설정
        if (chartInstance) {
            chartInstance.destroy();
            chartInstance = null;
        }

        // 새 차트를 생성하고 인스턴스를 저장
        chartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: yValues.map(yVal => ({
                    label: yVal.label,
                    data: yVal.data,
                    borderWidth: 2,
                    fill: false,
                    borderColor: getRandomColor(), // Random color for each line
                }))
            },
            options: {
                responsive: true,
                maintainAspectRatio: true, // 비율 유지
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Measurement Date'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Values'
                        }
                    }
                }
            }
        });
    }

    // Function to return a random color
    function getRandomColor() {
        const letters = '0123456789ABCDEF';
        let color = '#';
        for (let i = 0; i < 6; i++) {
            color += letters[Math.floor(Math.random() * 16)];
        }
        return color;
    }
    </script>
</head>
<body>
    <!-- 헤더를 외부 프래그먼트로부터 가져오기 -->
    <div th:replace="fragments/header :: siteHeader"></div>
    <div>
        <select id="locNickSelect" name="locNick" onchange="fetchDeviceData(this.value, 1)">
            <th:block th:each="locNick : ${locNickList}">
                <option th:value="${locNick}" th:text="${locNick}"></option>
            </th:block>
        </select>

        <button onclick="fetchDeviceData(document.getElementById('locNickSelect').value, 1)">온습도 그래프</button>
        <button onclick="fetchDeviceData(document.getElementById('locNickSelect').value, 2)">풍속 그래프</button>
        <button onclick="fetchDeviceData(document.getElementById('locNickSelect').value, 3)">기압 그래프</button>
        <button onclick="fetchDeviceData(document.getElementById('locNickSelect').value, 4)">강수량 그래프</button>

        <canvas id="chart"></canvas>
    </div>
</body>
</html>